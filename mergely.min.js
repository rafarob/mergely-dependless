"use strict";(function(d,a,e,c){var b={};b.Timer=function(){var f=this;f.start=function(){f.t0=new Date().getTime()};f.stop=function(){var g=new Date().getTime();var h=g-f.t0;f.t0=g;return h};f.start()};b.ChangeExpression=new RegExp(/(^(?![><\-])*\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);b.DiffParser=function(n){var l=[];var o=0;var h=n.split(/\n/);for(var f=0;f<h.length;++f){if(h[f].length==0){continue}var k={};var j=b.ChangeExpression.exec(h[f]);if(j==null){continue}var g=j[1].split(",");k["lhs-line-from"]=g[0]-1;if(g.length==1){k["lhs-line-to"]=g[0]-1}else{k["lhs-line-to"]=g[1]-1}var m=j[3].split(",");k["rhs-line-from"]=m[0]-1;if(m.length==1){k["rhs-line-to"]=m[0]-1}else{k["rhs-line-to"]=m[1]-1}k.op=j[2];l[o++]=k}return l};b.sizeOf=function(h){var g=0,f;for(f in h){if(h.hasOwnProperty(f)){g++}}return g};b.LCS=function(f,g){this.x=f.replace(/[ ]{1}/g,"\n");this.y=g.replace(/[ ]{1}/g,"\n")};e.extend(b.LCS.prototype,{clear:function(){this.ready=0},diff:function(m,j){var k=new b.diff(this.x,this.y,{ignorews:false});var n=b.DiffParser(k.normal_form());var p=0,o=0;for(var g=0;g<n.length;++g){var l=n[g];if(l.op!="a"){p=k.getLines("lhs").slice(0,l["lhs-line-from"]).join(" ").length;o=l["lhs-line-to"]+1;var f=k.getLines("lhs").slice(l["lhs-line-from"],o).join(" ");if(l.op=="d"){f+=" "}else{if(p>0&&l.op=="c"){p+=1}}j(p,p+f.length)}if(l.op!="d"){p=k.getLines("rhs").slice(0,l["rhs-line-from"]).join(" ").length;o=l["rhs-line-to"]+1;var h=k.getLines("rhs").slice(l["rhs-line-from"],o).join(" ");if(l.op=="a"){h+=" "}else{if(p>0&&l.op=="c"){p+=1}}m(p,p+h.length)}}}});b.CodeifyText=function(f){this._max_code=0;this._diff_codes={};this.ctxs={};this.options={ignorews:false};e.extend(this,f);this.lhs=f.lhs.split("\n");this.rhs=f.rhs.split("\n")};e.extend(b.CodeifyText.prototype,{getCodes:function(g){if(!this.ctxs.hasOwnProperty(g)){var f=this._diff_ctx(this[g]);this.ctxs[g]=f;f.codes.length=Object.keys(f.codes).length}return this.ctxs[g].codes},getLines:function(f){return this.ctxs[f].lines},_diff_ctx:function(g){var f={i:0,codes:{},lines:g};this._codeify(g,f);return f},_codeify:function(h,g){var l=this._max_code;for(var k=0;k<h.length;++k){var f=h[k];if(this.options.ignorews){f=f.replace(/\s+/g,"")}var j=this._diff_codes[f];if(j!=undefined){g.codes[k]=j}else{this._max_code++;this._diff_codes[f]=this._max_code;g.codes[k]=this._max_code}}}});b.diff=function(h,j,n){var f=e.extend({ignorews:false},n);this.codeify=new b.CodeifyText({lhs:h,rhs:j,options:f});var l={codes:this.codeify.getCodes("lhs"),modified:{}};var m={codes:this.codeify.getCodes("rhs"),modified:{}};var k=(l.codes.length+m.codes.length+1);var g=[];var i=[];this._lcs(l,0,l.codes.length,m,0,m.codes.length,i,g);this._optimize(l);this._optimize(m);this.items=this._create_diffs(l,m)};e.extend(b.diff.prototype,{changes:function(){return this.items},getLines:function(f){return this.codeify.getLines(f)},normal_form:function(){var g="";for(var k=0;k<this.items.length;++k){var o=this.items[k];var j="";var m="";var n="c";if(o.lhs_deleted_count==0&&o.rhs_inserted_count>0){n="a"}else{if(o.lhs_deleted_count>0&&o.rhs_inserted_count==0){n="d"}}if(o.lhs_deleted_count==1){j=o.lhs_start+1}else{if(o.lhs_deleted_count==0){j=o.lhs_start}else{j=(o.lhs_start+1)+","+(o.lhs_start+o.lhs_deleted_count)}}if(o.rhs_inserted_count==1){m=o.rhs_start+1}else{if(o.rhs_inserted_count==0){m=o.rhs_start}else{m=(o.rhs_start+1)+","+(o.rhs_start+o.rhs_inserted_count)}}g+=j+n+m+"\n";var l=this.getLines("lhs");var f=this.getLines("rhs");if(f&&l){var h;for(h=o.lhs_start;h<o.lhs_start+o.lhs_deleted_count;++h){g+="< "+l[h]+"\n"}if(o.rhs_inserted_count&&o.lhs_deleted_count){g+="---\n"}for(h=o.rhs_start;h<o.rhs_start+o.rhs_inserted_count;++h){g+="> "+f[h]+"\n"}}}return g},_lcs:function(m,f,j,n,l,h,k,i){while((f<j)&&(l<h)&&(m.codes[f]==n.codes[l])){++f;++l}while((f<j)&&(l<h)&&(m.codes[j-1]==n.codes[h-1])){--j;--h}if(f==j){while(l<h){n.modified[l++]=true}}else{if(l==h){while(f<j){m.modified[f++]=true}}else{var g=this._sms(m,f,j,n,l,h,k,i);this._lcs(m,f,g.x,n,l,g.y,k,i);this._lcs(m,g.x,j,n,g.y,h,k,i)}}},_sms:function(f,o,i,r,z,s,g,j){var u=f.codes.length+r.codes.length+1;var n=o-z;var q=i-s;var A=(i-o)-(s-z);var h=(A&1)!=0;var v=u-n;var B=u-q;var p=((i-o+s-z)/2)+1;j[v+n+1]=o;g[B+q-1]=i;var C={x:0,y:0},w,t,m,l;for(w=0;w<=p;++w){for(t=n-w;t<=n+w;t+=2){if(t==n-w){m=j[v+t+1]}else{m=j[v+t-1]+1;if((t<(n+w))&&(j[v+t+1]>=m)){m=j[v+t+1]}}l=m-t;while((m<i)&&(l<s)&&(f.codes[m]==r.codes[l])){m++;l++}j[v+t]=m;if(h&&(q-w<t)&&(t<q+w)){if(g[B+t]<=j[v+t]){C.x=j[v+t];C.y=j[v+t]-t;return(C)}}}for(t=q-w;t<=q+w;t+=2){if(t==q+w){m=g[B+t-1]}else{m=g[B+t+1]-1;if((t>q-w)&&(g[B+t-1]<m)){m=g[B+t-1]}}l=m-t;while((m>o)&&(l>z)&&(f.codes[m-1]==r.codes[l-1])){m--;l--}g[B+t]=m;if(!h&&(n-w<=t)&&(t<=n+w)){if(g[B+t]<=j[v+t]){C.x=j[v+t];C.y=j[v+t]-t;return(C)}}}}throw"the algorithm should never come here."},_optimize:function(g){var h=0,f=0;while(h<g.codes.length){while((h<g.codes.length)&&(g.modified[h]==undefined||g.modified[h]==false)){h++}f=h;while((f<g.codes.length)&&(g.modified[f]==true)){f++}if((f<g.codes.length)&&(g.codes[h]==g.codes[f])){g.modified[h]=false;g.modified[f]=true}else{h=f}}},_create_diffs:function(h,l){var f=[];var k=0,g=0;var j=0,i=0;while(j<h.codes.length||i<l.codes.length){if((j<h.codes.length)&&(!h.modified[j])&&(i<l.codes.length)&&(!l.modified[i])){j++;i++}else{k=j;g=i;while(j<h.codes.length&&(i>=l.codes.length||h.modified[j])){j++}while(i<l.codes.length&&(j>=h.codes.length||l.modified[i])){i++}if((k<j)||(g<i)){f.push({lhs_start:k,rhs_start:g,lhs_deleted_count:j-k,rhs_inserted_count:i-g})}}}return f}});b.mergely=function(g,f){if(g){this.init(g,f)}};e.extend(b.mergely.prototype,{name:"mergely",init:function(g,f){this.diffView=new b.CodeMirrorDiffView(g,f);this.bind(g)},bind:function(f){this.diffView.bind(f)}});b.CodeMirrorDiffView=function(g,f){c.defineExtension("centerOnCursor",function(){var h=this.cursorCoords(null,"local");this.scrollTo(null,(h.y+h.yBot)/2-(this.getScrollerElement().clientHeight/2))});this.init(g,f)};e.extend(b.CodeMirrorDiffView.prototype,{init:function(h,g){this.settings={autoupdate:true,autoresize:true,rhs_margin:"right",wrap_lines:false,line_numbers:true,lcs:true,sidebar:true,viewport:false,ignorews:false,fadein:"fast",editor_width:"650px",editor_height:"400px",resize_timeout:500,change_timeout:150,fgcolor:{a:"#4ba3fa",c:"#a3a3a3",d:"#ff7f7f",ca:"#4b73ff",cc:"#434343",cd:"#ff4f4f"},bgcolor:"#eee",vpcolor:"rgba(0, 0, 200, 0.5)",lhs:function(i){},rhs:function(i){},loaded:function(){},_auto_width:function(i){return i},resize:function(n){var o=n?16:0;var j=e(h).parent().width()+o,l=0;if(this.width=="auto"){j=this._auto_width(j)}else{j=this.width;this.editor_width=j}if(this.height=="auto"){l=e(h).parent().height()}else{l=this.height;this.editor_height=l}var m=j/2-2*8-8;var i=l;var k=e(h);k.find(".mergely-column").css({width:m+"px"});k.find(".mergely-column, .mergely-canvas, .mergely-margin, .mergely-column textarea, .CodeMirror-scroll, .cm-s-default").css({height:i+"px"});k.find(".mergely-canvas").css({height:i+"px"});k.find(".mergely-column textarea").css({width:m+"px"});k.css({width:j,height:l,clear:"both"});if(k.css("display")=="none"){if(this.fadein!=false){k.fadeIn(this.fadein)}else{k.show()}if(this.loaded){this.loaded()}}if(this.resized){this.resized()}},_debug:"",resized:function(){}};var f={mode:"text/plain",readOnly:false,lineWrapping:this.settings.wrap_lines,lineNumbers:this.settings.line_numbers,gutters:["merge","CodeMirror-linenumbers"]};this.lhs_cmsettings={};this.rhs_cmsettings={};this.element=e(h);if(g&&g.cmsettings){e.extend(this.lhs_cmsettings,f,g.cmsettings,g.lhs_cmsettings)}if(g&&g.cmsettings){e.extend(this.rhs_cmsettings,f,g.cmsettings,g.rhs_cmsettings)}this.element.bind("destroyed",e.proxy(this.teardown,this));e.data(h,"mergely",this);this._setOptions(g)},unbind:function(){if(this.changed_timeout!=null){clearTimeout(this.changed_timeout)}this.editor[this.id+"-lhs"].toTextArea();this.editor[this.id+"-rhs"].toTextArea();e(d).off(".mergely")},destroy:function(){this.element.unbind("destroyed",this.teardown);this.teardown()},teardown:function(){this.unbind()},lhs:function(f){this.editor[this.id+"-lhs"].setValue(f)},rhs:function(f){this.editor[this.id+"-rhs"].setValue(f)},update:function(){this._changing(this.id+"-lhs",this.id+"-rhs")},unmarkup:function(){this._clear()},scrollToDiff:function(f){if(!this.changes.length){return}if(f=="next"){this._current_diff=Math.min(++this._current_diff,this.changes.length-1)}else{if(f=="prev"){this._current_diff=Math.max(--this._current_diff,0)}}this._scroll_to_change(this.changes[this._current_diff]);this._changed(this.id+"-lhs",this.id+"-rhs")},mergeCurrentChange:function(f){if(!this.changes.length){return}if(f=="lhs"&&!this.lhs_cmsettings.readOnly){this._merge_change(this.changes[this._current_diff],"rhs","lhs")}else{if(f=="rhs"&&!this.rhs_cmsettings.readOnly){this._merge_change(this.changes[this._current_diff],"lhs","rhs")}}},scrollTo:function(h,f){var g=this.editor[this.id+"-lhs"];var i=this.editor[this.id+"-rhs"];if(h=="lhs"){g.setCursor(f);g.centerOnCursor()}else{i.setCursor(f);i.centerOnCursor()}},_setOptions:function(h){e.extend(this.settings,h);if(this.settings.hasOwnProperty("rhs_margin")){if(this.settings.rhs_margin=="left"){this.element.find(".mergely-margin:last-child").insertAfter(this.element.find(".mergely-canvas"))}else{var i=this.element.find(".mergely-margin").last();i.appendTo(i.parent())}}if(this.settings.hasOwnProperty("sidebar")){if(this.settings.sidebar){this.element.find(".mergely-margin").css({display:"block"})}else{this.element.find(".mergely-margin").css({display:"none"})}}var f,g;if(this.settings.hasOwnProperty("wrap_lines")){if(this.editor){f=this.editor[this.id+"-lhs"];g=this.editor[this.id+"-rhs"];f.setOption("lineWrapping",this.settings.wrap_lines);g.setOption("lineWrapping",this.settings.wrap_lines)}}if(this.settings.hasOwnProperty("line_numbers")){if(this.editor){f=this.editor[this.id+"-lhs"];g=this.editor[this.id+"-rhs"];f.setOption("lineNumbers",this.settings.line_numbers);g.setOption("lineNumbers",this.settings.line_numbers)}}},options:function(f){if(f){this._setOptions(f);if(this.settings.autoresize){this.resize()}if(this.settings.autoupdate){this.update()}}else{return this.settings}},swap:function(){if(this.lhs_cmsettings.readOnly||this.rhs_cmsettings.readOnly){return}var g=this.editor[this.id+"-lhs"];var h=this.editor[this.id+"-rhs"];var f=h.getValue();h.setValue(g.getValue());g.setValue(f)},merge:function(g){var f=this.editor[this.id+"-lhs"];var h=this.editor[this.id+"-rhs"];if(g=="lhs"&&!this.lhs_cmsettings.readOnly){f.setValue(h.getValue())}else{if(!this.rhs_cmsettings.readOnly){h.setValue(f.getValue())}}},get:function(h){var f=this.editor[this.id+"-"+h];var g=f.getValue();if(g==undefined){return""}return g},clear:function(g){if(g=="lhs"&&this.lhs_cmsettings.readOnly){return}if(g=="rhs"&&this.rhs_cmsettings.readOnly){return}var f=this.editor[this.id+"-"+g];f.setValue("")},cm:function(f){return this.editor[this.id+"-"+f]},search:function(g,j,k){var f=this.editor[this.id+"-lhs"];var i=this.editor[this.id+"-rhs"];var h;if(g=="lhs"){h=f}else{h=i}k=(k=="prev")?"findPrevious":"findNext";if((h.getSelection().length==0)||(this.prev_query[g]!=j)){this.cursor[this.id]=h.getSearchCursor(j,{line:0,ch:0},false);this.prev_query[g]=j}var l=this.cursor[this.id];if(l[k]()){h.setSelection(l.from(),l.to())}else{l=h.getSearchCursor(j,{line:0,ch:0},false)}},resize:function(){this.settings.resize();this._changing(this.id+"-lhs",this.id+"-rhs");this._set_top_offset(this.id+"-lhs")},diff:function(){var f=this.editor[this.id+"-lhs"].getValue();var h=this.editor[this.id+"-rhs"].getValue();var g=new b.diff(f,h,this.settings);return g.normal_form()},bind:function(i){this.element.hide();this.id=e(i).attr("id");this.changed_timeout=null;this.chfns={};this.chfns[this.id+"-lhs"]=[];this.chfns[this.id+"-rhs"]=[];this.prev_query=[];this.cursor=[];this._skipscroll={};this.change_exp=new RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);var n;var u;if(e.button!=undefined){n='<button title="Merge left"></button>';u='<button title="Merge right"></button>'}else{var f="opacity:0.4;width:10px;height:15px;background-color:#888;cursor:pointer;text-align:center;color:#eee;border:1px solid: #222;margin-right:5px;margin-top: -2px;";n='<div style="'+f+'" title="Merge left">&lt;</div>';u='<div style="'+f+'" title="Merge right">&gt;</div>'}this.merge_rhs_button=e(u);this.merge_lhs_button=e(n);var s=this.settings.editor_height;var g=this.settings.editor_width;this.element.append(e('<div class="mergely-margin" style="height: '+s+'"><canvas id="'+this.id+'-lhs-margin" width="8px" height="'+s+'"></canvas></div>'));this.element.append(e('<div style="position:relative;width:'+g+"; height:"+s+'" id="'+this.id+'-editor-lhs" class="mergely-column"><textarea style="" id="'+this.id+'-lhs"></textarea></div>'));this.element.append(e('<div class="mergely-canvas" style="height: '+s+'"><canvas id="'+this.id+"-lhs-"+this.id+'-rhs-canvas" style="width:28px" width="28px" height="'+s+'"></canvas></div>'));var h=e('<div class="mergely-margin" style="height: '+s+'"><canvas id="'+this.id+'-rhs-margin" width="8px" height="'+s+'"></canvas></div>');if(!this.settings.sidebar){this.element.find(".mergely-margin").css({display:"none"})}if(this.settings.rhs_margin=="left"){this.element.append(h)}this.element.append(e('<div style="width:'+g+"; height:"+s+'" id="'+this.id+'-editor-rhs" class="mergely-column"><textarea style="" id="'+this.id+'-rhs"></textarea></div>'));if(this.settings.rhs_margin!="left"){this.element.append(h)}var k=e('<div style="display:none" class="mergely current start" />').appendTo("body").css("border-top-color");this.current_diff_color=k;var j="#"+this.id+" .CodeMirror-gutter-text { padding: 5px 0 0 0; }\n#"+this.id+" .CodeMirror-lines pre, #"+this.id+" .CodeMirror-gutter-text pre { line-height: 18px; }\n#"+this.id+" .CodeMirror-linewidget { overflow: hidden; }\n";if(this.settings.autoresize){j+="#"+this.id+" .CodeMirror-scroll { height: 100%; overflow: auto; }\n"}j+="#"+this.id+" .CodeMirror { line-height: 18px; }";e('<style type="text/css">'+j+"</style>").appendTo("head");var l=this.element.find("#"+this.id+"-rhs").get(0);if(!l){console.error("rhs textarea not defined - Mergely not initialized properly");return}var r=this.element.find("#"+this.id+"-lhs").get(0);if(!l){console.error("lhs textarea not defined - Mergely not initialized properly");return}var t=this;this.editor=[];this.editor[this.id+"-lhs"]=c.fromTextArea(r,this.lhs_cmsettings);this.editor[this.id+"-rhs"]=c.fromTextArea(l,this.rhs_cmsettings);this.editor[this.id+"-lhs"].on("change",function(){if(t.settings.autoupdate){t._changing(t.id+"-lhs",t.id+"-rhs")}});this.editor[this.id+"-lhs"].on("scroll",function(){t._scrolling(t.id+"-lhs")});this.editor[this.id+"-rhs"].on("change",function(){if(t.settings.autoupdate){t._changing(t.id+"-lhs",t.id+"-rhs")}});this.editor[this.id+"-rhs"].on("scroll",function(){t._scrolling(t.id+"-rhs")});if(this.settings.autoresize){var q=null;var o=function(v){if(t.settings.resize){t.settings.resize(v)}t.editor[t.id+"-lhs"].refresh();t.editor[t.id+"-rhs"].refresh();if(t.settings.autoupdate){t._changing(t.id+"-lhs",t.id+"-rhs")}};e(d).on("resize.mergely",function(){if(q){clearTimeout(q)}q=setTimeout(o,t.settings.resize_timeout)});o(true)}function p(x,v,y){if(y.target&&(e(y.target).closest(".merge-button").length>0)){return}var w,z;for(w=0;w<this.changes.length;w++){z=this.changes[w];if(v>=z[x+"-line-from"]&&v<=z[x+"-line-to"]){this._current_diff=w;setTimeout(function(){this.scrollToDiff()}.bind(this),10);break}}}this.editor[this.id+"-lhs"].on("gutterClick",function(v,y,x,w){p.call(this,"lhs",y,w)}.bind(this));this.editor[this.id+"-rhs"].on("gutterClick",function(v,y,x,w){p.call(this,"rhs",y,w)}.bind(this));var m;if(this.settings.lhs){m=this.editor[this.id+"-lhs"].getDoc().setValue;this.settings.lhs(m.bind(this.editor[this.id+"-lhs"].getDoc()))}if(this.settings.rhs){m=this.editor[this.id+"-rhs"].getDoc().setValue;this.settings.rhs(m.bind(this.editor[this.id+"-rhs"].getDoc()))}},_scroll_to_change:function(i){if(!i){return}var f=this;var h=f.editor[f.id+"-lhs"];var g=f.editor[f.id+"-rhs"];h.setCursor(Math.max(i["lhs-line-from"],0),0);g.setCursor(Math.max(i["rhs-line-from"],0),0);h.scrollIntoView({line:i["lhs-line-to"]})},_scrolling:function(k){if(this._skipscroll[k]===true){this._skipscroll[k]=false;return}var t=e(this.editor[k].getScrollerElement());if(this.midway==undefined){this.midway=(t.height()/2+t.offset().top).toFixed(2)}var o=this.editor[k].coordsChar({left:0,top:this.midway});var j=t.scrollTop();var p=t.scrollLeft();this.trace("scroll","side",k);this.trace("scroll","midway",this.midway);this.trace("scroll","midline",o);this.trace("scroll","top_to",j);this.trace("scroll","left_to",p);var g=this.id+"-lhs";var x=this.id+"-rhs";for(var w in this.editor){if(!this.editor.hasOwnProperty(w)){continue}if(k==w){continue}var s=k.replace(this.id+"-","");var l=w.replace(this.id+"-","");var u=0;var f=null;var v=false;for(var q=0;q<this.changes.length;++q){var n=this.changes[q];if((o.line>=n[s+"-line-from"])){f=n;if(o.line>=f[s+"-line-to"]){if(!n.hasOwnProperty(s+"-y-start")||!n.hasOwnProperty(s+"-y-end")||!n.hasOwnProperty(l+"-y-start")||!n.hasOwnProperty(l+"-y-end")){v=true}else{u+=(n[s+"-y-end"]-n[s+"-y-start"])-(n[l+"-y-end"]-n[l+"-y-start"])}}}}var r=this.editor[w].getViewport();var h=true;if(f){this.trace("scroll","last change before midline",f);if(o.line>=r.from&&o<=r.to){h=false}}this.trace("scroll","scroll",h);if(h||v){this.trace("scroll","scrolling other side",j-u);this._skipscroll[w]=true;this.editor[w].scrollTo(p,j-u)}else{this.trace("scroll","not scrolling other side")}if(this.settings.autoupdate){var m=new b.Timer();this._calculate_offsets(g,x,this.changes);this.trace("change","offsets time",m.stop());this._markup_changes(g,x,this.changes);this.trace("change","markup time",m.stop());this._draw_diff(g,x,this.changes);this.trace("change","draw time",m.stop())}this.trace("scroll","scrolled")}},_changing:function(h,g){this.trace("change","changing-timeout",this.changed_timeout);var f=this;if(this.changed_timeout!=null){clearTimeout(this.changed_timeout)}this.changed_timeout=setTimeout(function(){var i=new b.Timer();f._changed(h,g);f.trace("change","total time",i.stop())},this.settings.change_timeout)},_changed:function(g,f){this._clear();this._diff(g,f)},_clear:function(){var t=this,f,m,q,g,k,p,h;var s=function(){g=new b.Timer();for(k=0,h=m.lineCount();k<h;++k){m.removeLineClass(k,"background")}for(k=0;k<q.length;++k){p=q[k];if(p.lines.length){t.trace("change","clear text",p.lines[0].text)}p.clear()}m.clearGutter("merge");t.trace("change","clear time",g.stop())};for(f in this.editor){if(!this.editor.hasOwnProperty(f)){continue}m=this.editor[f];q=t.chfns[f];m.operation(s)}t.chfns[f]=[];var n=this._draw_info(this.id+"-lhs",this.id+"-rhs");var j=n.clhs.get(0).getContext("2d");var o=n.crhs.get(0).getContext("2d");var r=n.dcanvas.getContext("2d");j.beginPath();j.fillStyle=this.settings.bgcolor;j.strokeStyle="#888";j.fillRect(0,0,6.5,n.visible_page_height);j.strokeRect(0,0,6.5,n.visible_page_height);o.beginPath();o.fillStyle=this.settings.bgcolor;o.strokeStyle="#888";o.fillRect(0,0,6.5,n.visible_page_height);o.strokeRect(0,0,6.5,n.visible_page_height);r.beginPath();r.fillStyle="#fff";r.fillRect(0,0,this.draw_mid_width,n.visible_page_height)},_diff:function(h,g){var f=this.editor[h].getValue();var k=this.editor[g].getValue();var j=new b.Timer();var i=new b.diff(f,k,this.settings);this.trace("change","diff time",j.stop());this.changes=b.DiffParser(i.normal_form());this.trace("change","parse time",j.stop());if(this._current_diff===undefined&&this.changes.length){this._current_diff=0;this._scroll_to_change(this.changes[0])}this.trace("change","scroll_to_change time",j.stop());this._calculate_offsets(h,g,this.changes);this.trace("change","offsets time",j.stop());this._markup_changes(h,g,this.changes);this.trace("change","markup time",j.stop());this._draw_diff(h,g,this.changes);this.trace("change","draw time",j.stop())},_parse_diff:function(g,f,p){this.trace("diff","diff results:\n",p);var n=[];var q=0;var k=p.split(/\n/);for(var h=0;h<k.length;++h){if(k[h].length==0){continue}var m={};var l=this.change_exp.exec(k[h]);if(l==null){continue}var j=l[1].split(",");m["lhs-line-from"]=j[0]-1;if(j.length==1){m["lhs-line-to"]=j[0]-1}else{m["lhs-line-to"]=j[1]-1}var o=l[3].split(",");m["rhs-line-from"]=o[0]-1;if(o.length==1){m["rhs-line-to"]=o[0]-1}else{m["rhs-line-to"]=o[1]-1}if(m["lhs-line-from"]<0){m["lhs-line-from"]=0}if(m["lhs-line-to"]<0){m["lhs-line-to"]=0}if(m["rhs-line-from"]<0){m["rhs-line-from"]=0}if(m["rhs-line-to"]<0){m["rhs-line-to"]=0}m.op=l[2];n[q++]=m;this.trace("diff","change",m)}return n},_get_viewport:function(h,g){var i=this.editor[h].getViewport();var f=this.editor[g].getViewport();return{from:Math.min(i.from,f.from),to:Math.max(i.to,f.to)}},_is_change_in_view:function(f,g){if(!this.settings.viewport){return true}if((g["lhs-line-from"]<f.from&&g["lhs-line-to"]<f.to)||(g["lhs-line-from"]>f.from&&g["lhs-line-to"]>f.to)||(g["rhs-line-from"]<f.from&&g["rhs-line-to"]<f.to)||(g["rhs-line-from"]>f.from&&g["rhs-line-to"]>f.to)){return false}return true},_set_top_offset:function(g){var i=this.editor[g].getScrollInfo().top;this.editor[g].scrollTo(null,0);var h=this.element.find(".CodeMirror-measure").first();var f=h.offset().top-4;if(!f){return false}this.editor[g].scrollTo(null,i);this.draw_top_offset=0.5-f;return true},_calculate_offsets:function(f,C,B){if(this.em_height==null){if(!this._set_top_offset(f)){return}this.em_height=this.editor[f].defaultTextHeight();if(!this.em_height){console.warn("Failed to calculate offsets, using 18 by default");this.em_height=18}this.draw_lhs_min=0.5;var z=e("#"+f+"-"+C+"-canvas");if(!z.length){console.error("failed to find canvas","#"+f+"-"+C+"-canvas")}if(!z.width()){console.error("canvas width is 0");return}this.draw_mid_width=e("#"+f+"-"+C+"-canvas").width();this.draw_rhs_max=this.draw_mid_width-0.5;this.draw_lhs_width=5;this.draw_rhs_width=5;this.trace("calc","change offsets calculated",{top_offset:this.draw_top_offset,lhs_min:this.draw_lhs_min,rhs_max:this.draw_rhs_max,lhs_width:this.draw_lhs_width,rhs_width:this.draw_rhs_width})}var q=this.editor[f].charCoords({line:0});var k=this.editor[C].charCoords({line:0});var y=this._get_viewport(f,C);for(var w=0;w<B.length;++w){var o=B[w];if(!this.settings.sidebar&&!this._is_change_in_view(y,o)){delete o["lhs-y-start"];delete o["lhs-y-end"];delete o["rhs-y-start"];delete o["rhs-y-end"];continue}var j=o["lhs-line-from"]>=0?o["lhs-line-from"]:0;var g=o["lhs-line-to"]>=0?o["lhs-line-to"]:0;var u=o["rhs-line-from"]>=0?o["rhs-line-from"]:0;var m=o["rhs-line-to"]>=0?o["rhs-line-to"]:0;var h,s,l,t,p,x,A,v,n,r;if(this.editor[f].getOption("lineWrapping")||this.editor[C].getOption("lineWrapping")){p=this.editor[f].cursorCoords({line:j,ch:0},"page");v=this.editor[f].getLineHandle(j);h={top:p.top,bottom:p.top+v.height};x=this.editor[f].cursorCoords({line:g,ch:0},"page");A=this.editor[f].getLineHandle(g);s={top:x.top,bottom:x.top+A.height};p=this.editor[C].cursorCoords({line:u,ch:0},"page");n=this.editor[C].getLineHandle(u);l={top:p.top,bottom:p.top+n.height};x=this.editor[C].cursorCoords({line:m,ch:0},"page");r=this.editor[C].getLineHandle(m);t={top:x.top,bottom:x.top+r.height}}else{h={top:q.top+j*this.em_height,bottom:q.bottom+j*this.em_height+2};s={top:q.top+g*this.em_height,bottom:q.bottom+g*this.em_height+2};l={top:k.top+u*this.em_height,bottom:k.bottom+u*this.em_height+2};t={top:k.top+m*this.em_height,bottom:k.bottom+m*this.em_height+2}}if(o.op=="a"){if(u>0){h.top=h.bottom;h.bottom+=this.em_height;s=h}}else{if(o.op=="d"){if(j>0){l.top=l.bottom;l.bottom+=this.em_height;t=l}}}o["lhs-y-start"]=this.draw_top_offset+h.top;if(o.op=="c"||o.op=="d"){o["lhs-y-end"]=this.draw_top_offset+s.bottom}else{o["lhs-y-end"]=this.draw_top_offset+s.top}o["rhs-y-start"]=this.draw_top_offset+l.top;if(o.op=="c"||o.op=="a"){o["rhs-y-end"]=this.draw_top_offset+t.bottom}else{o["rhs-y-end"]=this.draw_top_offset+t.top}this.trace("calc","change calculated",w,o)}return B},_markup_changes:function(g,Q,N){this.element.find(".merge-button").remove();var x=this;var P=this.editor[g];var r=this.editor[Q];var A=this._current_diff;var w=new b.Timer();P.operation(function(){for(var R=0;R<N.length;++R){var U=N[R];var S=U["lhs-line-from"]>=0?U["lhs-line-from"]:0;var W=U["lhs-line-to"]>=0?U["lhs-line-to"]:0;var V=U["rhs-line-from"]>=0?U["rhs-line-from"]:0;var n=U["rhs-line-to"]>=0?U["rhs-line-to"]:0;var T=["mergely","lhs",U.op,"cid-"+R];P.addLineClass(S,"background","start");P.addLineClass(W,"background","end");if(A==R){if(S!=W){P.addLineClass(S,"background","current")}P.addLineClass(W,"background","current")}if(S==0&&W==0&&V==0){P.addLineClass(S,"background",T.join(" "));P.addLineClass(S,"background","first")}else{for(var p=S;p<=W;++p){P.addLineClass(p,"background",T.join(" "));P.addLineClass(p,"background",T.join(" "))}}if(!r.getOption("readOnly")){var k=x.merge_rhs_button.clone();if(k.button){k.button({icons:{primary:"ui-icon-triangle-1-e"},text:false})}k.addClass("merge-button");k.attr("id","merge-rhs-"+R);P.setGutterMarker(S,"merge",k.get(0))}}});var I=this._get_viewport(g,Q);this.trace("change","markup lhs-editor time",w.stop());r.operation(function(){for(var p=0;p<N.length;++p){var U=N[p];var R=U["lhs-line-from"]>=0?U["lhs-line-from"]:0;var W=U["lhs-line-to"]>=0?U["lhs-line-to"]:0;var V=U["rhs-line-from"]>=0?U["rhs-line-from"]:0;var k=U["rhs-line-to"]>=0?U["rhs-line-to"]:0;if(!x._is_change_in_view(I,U)){continue}var S=["mergely","rhs",U.op,"cid-"+p];r.addLineClass(V,"background","start");r.addLineClass(k,"background","end");if(A==p){if(V!=k){r.addLineClass(V,"background","current")}r.addLineClass(k,"background","current")}if(V==0&&k==0&&R==0){r.addLineClass(V,"background",S.join(" "));r.addLineClass(V,"background","first")}else{for(var n=V;n<=k;++n){r.addLineClass(n,"background",S.join(" "));r.addLineClass(n,"background",S.join(" "))}}if(!P.getOption("readOnly")){var T=x.merge_lhs_button.clone();if(T.button){T.button({icons:{primary:"ui-icon-triangle-1-w"},text:false})}T.addClass("merge-button");T.attr("id","merge-lhs-"+p);r.setGutterMarker(V,"merge",T.get(0))}}});this.trace("change","markup rhs-editor time",w.stop());var D=[],H,G,F,z;for(H=0;this.settings.lcs&&H<N.length;++H){var v=N[H];var s=v["lhs-line-from"]>=0?v["lhs-line-from"]:0;var h=v["lhs-line-to"]>=0?v["lhs-line-to"]:0;var C=v["rhs-line-from"]>=0?v["rhs-line-from"]:0;var t=v["rhs-line-to"]>=0?v["rhs-line-to"]:0;if(!this._is_change_in_view(I,v)){continue}if(v.op=="d"){var E=s;var m=h;var l=P.lineInfo(m);if(l){D.push([P,{line:E,ch:0},{line:m,ch:l.text.length},{className:"mergely ch d lhs"}])}}else{if(v.op=="c"){for(G=s,F=C,z=0;((G>=0)&&(G<=h))||((F>=0)&&(F<=t));++G,++F){var L,u;if(F+z>t){L=P.getLine(G);D.push([P,{line:G,ch:0},{line:G,ch:L.length},{className:"mergely ch d lhs"}]);continue}if(G+z>h){u=r.getLine(F);D.push([r,{line:F,ch:0},{line:F,ch:u.length},{className:"mergely ch a rhs"}]);continue}L=P.getLine(G);u=r.getLine(F);var O=new b.LCS(L,u);O.diff(function q(j,i){D.push([r,{line:F,ch:j},{line:F,ch:i},{className:"mergely ch a rhs"}])},function J(j,i){D.push([P,{line:G,ch:j},{line:G,ch:i},{className:"mergely ch d lhs"}])})}}}}this.trace("change","LCS marktext time",w.stop());P.operation(function(){for(var k=0;k<D.length;++k){var j=D[k];if(j[0].doc.id!=P.getDoc().id){continue}x.chfns[x.id+"-lhs"].push(j[0].markText(j[1],j[2],j[3]))}});r.operation(function(){for(var k=0;k<D.length;++k){var j=D[k];if(j[0].doc.id!=r.getDoc().id){continue}x.chfns[x.id+"-rhs"].push(j[0].markText(j[1],j[2],j[3]))}});this.trace("change","LCS markup time",w.stop());var o={lhs:P,rhs:r};this.element.find(".merge-button").on("click",function(k){var i="rhs";var T="lhs";var j=e(this).parents("#"+x.id+"-editor-lhs");if(j.length){i="lhs";T="rhs"}var S=o[i].coordsChar({left:k.pageX,top:k.pageY});var R=null;var n=o[i].lineInfo(S.line);e.each(n.bgClass.split(" "),function(V,U){if(U.indexOf("cid-")==0){R=parseInt(U.split("-")[1],10);return false}});var p=x.changes[R];x._merge_change(p,i,T);return false});var M=e("#mergely-lhs ~ .CodeMirror").find(".CodeMirror-linenumber");var f=e("#mergely-rhs ~ .CodeMirror").find(".CodeMirror-linenumber");f.removeClass("mergely current");M.removeClass("mergely current");for(var H=0;H<N.length;++H){if(A==H&&v.op!=="d"){var v=N[H];var G,K=v["rhs-line-from"],y=v["rhs-line-to"]+1;for(G=K;G<y;G++){var B=(G+1).toString();f.filter(function(j,k){return e(k).text()===B}).addClass("mergely current")}}if(A==H&&v.op!=="a"){var v=N[H];K=v["lhs-line-from"],y=v["lhs-line-to"]+1;for(G=K;G<y;G++){var B=(G+1).toString();M.filter(function(j,k){return e(k).text()===B}).addClass("mergely current")}}}this.trace("change","markup buttons time",w.stop())},_merge_change:function(k,j,o){if(!k){return}var p=this.editor[this.id+"-lhs"];var f=this.editor[this.id+"-rhs"];var h={lhs:p,rhs:f};var g,m,l;var n=h[j].getRange(c.Pos(k[j+"-line-from"],0),c.Pos(k[j+"-line-to"]+1,0));if(k.op=="c"){h[o].replaceRange(n,c.Pos(k[o+"-line-from"],0),c.Pos(k[o+"-line-to"]+1,0))}else{if(j=="rhs"){if(k.op=="a"){h[o].replaceRange(n,c.Pos(k[o+"-line-from"]+1,0),c.Pos(k[o+"-line-to"]+1,0))}else{m=parseInt(k[o+"-line-from"],10);l=parseInt(k[o+"-line-to"],10);for(g=l;g>=m;--g){h[o].setCursor({line:g,ch:-1});h[o].execCommand("deleteLine")}}}else{if(j=="lhs"){if(k.op=="a"){m=parseInt(k[o+"-line-from"],10);l=parseInt(k[o+"-line-to"],10);for(g=l;g>=m;--g){h[o].setCursor({line:g,ch:-1});h[o].execCommand("deleteLine")}}else{h[o].replaceRange(n,c.Pos(k[o+"-line-from"]+1,0))}}}}h.lhs.setValue(h.lhs.getValue());h.rhs.setValue(h.rhs.getValue());this._scroll_to_change(k)},_draw_info:function(h,g){var i=e(this.editor[h].getScrollerElement()).height();var j=e(this.editor[h].getScrollerElement()).children(":first-child").height();var l=a.getElementById(h+"-"+g+"-canvas");if(l==undefined){throw"Failed to find: "+h+"-"+g+"-canvas"}var f=this.element.find("#"+this.id+"-lhs-margin");var k=this.element.find("#"+this.id+"-rhs-margin");return{visible_page_height:i,gutter_height:j,visible_page_ratio:(i/j),margin_ratio:(i/j),lhs_scroller:e(this.editor[h].getScrollerElement()),rhs_scroller:e(this.editor[g].getScrollerElement()),lhs_lines:this.editor[h].lineCount(),rhs_lines:this.editor[g].lineCount(),dcanvas:l,clhs:f,crhs:k,lhs_xyoffset:e(f).offset(),rhs_xyoffset:e(k).offset()}},_draw_diff:function(f,J,I){var F=this._draw_info(f,J);var h=F.clhs.get(0);var r=F.crhs.get(0);var y=F.dcanvas.getContext("2d");var p=h.getContext("2d");var w=r.getContext("2d");this.trace("draw","visible_page_height",F.visible_page_height);this.trace("draw","gutter_height",F.gutter_height);this.trace("draw","visible_page_ratio",F.visible_page_ratio);this.trace("draw","lhs-scroller-top",F.lhs_scroller.scrollTop());this.trace("draw","rhs-scroller-top",F.rhs_scroller.scrollTop());e.each(this.element.find("canvas"),function(){e(this).get(0).height=F.visible_page_height});F.clhs.unbind("click");F.crhs.unbind("click");p.beginPath();p.fillStyle=this.settings.bgcolor;p.strokeStyle="#888";p.fillRect(0,0,6.5,F.visible_page_height);p.strokeRect(0,0,6.5,F.visible_page_height);w.beginPath();w.fillStyle=this.settings.bgcolor;w.strokeStyle="#888";w.fillRect(0,0,6.5,F.visible_page_height);w.strokeRect(0,0,6.5,F.visible_page_height);var E=this._get_viewport(f,J);for(var D=0;D<I.length;++D){var t=I[D];var B=this.settings.fgcolor[t.op];if(this._current_diff===D){B=this.current_diff_color}this.trace("draw",t);var k=((t["lhs-y-start"]+F.lhs_scroller.scrollTop())*F.visible_page_ratio);var v=((t["lhs-y-end"]+F.lhs_scroller.scrollTop())*F.visible_page_ratio)+1;var x=((t["rhs-y-start"]+F.rhs_scroller.scrollTop())*F.visible_page_ratio);var H=((t["rhs-y-end"]+F.rhs_scroller.scrollTop())*F.visible_page_ratio)+1;this.trace("draw","marker calculated",k,v,x,H);p.beginPath();p.fillStyle=B;p.strokeStyle="#000";p.lineWidth=0.5;p.fillRect(1.5,k,4.5,Math.max(v-k,5));p.strokeRect(1.5,k,4.5,Math.max(v-k,5));w.beginPath();w.fillStyle=B;w.strokeStyle="#000";w.lineWidth=0.5;w.fillRect(1.5,x,4.5,Math.max(H-x,5));w.strokeRect(1.5,x,4.5,Math.max(H-x,5));if(!this._is_change_in_view(E,t)){continue}k=t["lhs-y-start"];v=t["lhs-y-end"];x=t["rhs-y-start"];H=t["rhs-y-end"];var o=3;y.beginPath();y.strokeStyle=B;y.lineWidth=(this._current_diff==D)?1.5:1;var g=this.draw_lhs_width;var z=v-k-1;var C=this.draw_lhs_min;var A=k;y.moveTo(C,A);if(navigator.appName=="Microsoft Internet Explorer"){y.lineTo(this.draw_lhs_min+this.draw_lhs_width,k);y.lineTo(this.draw_lhs_min+this.draw_lhs_width,v+1);y.lineTo(this.draw_lhs_min,v+1)}else{if(z<=0){y.lineTo(C+g,A)}else{y.arcTo(C+g,A,C+g,A+o,o);y.arcTo(C+g,A+z,C+g-o,A+z,o)}y.lineTo(C,A+z)}y.stroke();g=this.draw_rhs_width;z=H-x-1;C=this.draw_rhs_max;A=x;y.moveTo(C,A);if(navigator.appName=="Microsoft Internet Explorer"){y.lineTo(this.draw_rhs_max-this.draw_rhs_width,x);y.lineTo(this.draw_rhs_max-this.draw_rhs_width,H+1);y.lineTo(this.draw_rhs_max,H+1)}else{if(z<=0){y.lineTo(C-g,A)}else{y.arcTo(C-g,A,C-g,A+o,o);y.arcTo(C-g,A+z,C-o,A+z,o)}y.lineTo(C,A+z)}y.stroke();var m=this.draw_lhs_min+this.draw_lhs_width;var l=k+(v+1-k)/2;var u=this.draw_rhs_max-this.draw_rhs_width;var s=x+(H+1-x)/2;y.moveTo(m,l);if(l==s){y.lineTo(u,s)}else{y.bezierCurveTo(m+12,l-3,u-12,s-3,u,s)}y.stroke()}p.fillStyle=this.settings.vpcolor;w.fillStyle=this.settings.vpcolor;var G=F.clhs.height()*F.visible_page_ratio;var q=(F.lhs_scroller.scrollTop()/F.gutter_height)*F.clhs.height();var n=F.crhs.height()*F.visible_page_ratio;var j=(F.rhs_scroller.scrollTop()/F.gutter_height)*F.crhs.height();this.trace("draw","cls.height",F.clhs.height());this.trace("draw","lhs_scroller.scrollTop()",F.lhs_scroller.scrollTop());this.trace("draw","gutter_height",F.gutter_height);this.trace("draw","visible_page_ratio",F.visible_page_ratio);this.trace("draw","lhs from",q,"lhs to",G);this.trace("draw","rhs from",j,"rhs to",n);p.fillRect(1.5,q,4.5,G);w.fillRect(1.5,j,4.5,n);F.clhs.click(function(K){var L=K.pageY-F.lhs_xyoffset.top-(G/2);var i=Math.max(0,(L/h.height)*F.lhs_scroller.get(0).scrollHeight);F.lhs_scroller.scrollTop(i)});F.crhs.click(function(K){var L=K.pageY-F.rhs_xyoffset.top-(n/2);var i=Math.max(0,(L/r.height)*F.rhs_scroller.get(0).scrollHeight);F.rhs_scroller.scrollTop(i)})},trace:function(f){if(this.settings._debug.indexOf(f)>=0){arguments[0]=f+":";console.log([].slice.apply(arguments))}}});e.pluginMaker=function(f){e.fn[f.prototype.name]=function(h){var g=e.makeArray(arguments),j=g.slice(1);var i;this.each(function(){var k=e.data(this,f.prototype.name);if(k){if(typeof h=="string"){i=k[h].apply(k,j)}else{if(k.update){return k.update.apply(k,g)}}}else{var l=new f(this,h)}});if(i!=undefined){return i}}};e.pluginMaker(b.mergely)})(window,document,jQuery,CodeMirror);